<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>1ëŒ€1 ê²½ìŸ ìŠ¤í„°ë”” - ìµœëŒ€ ì„±ì·¨ë„ ë„ì „</title>
    <!-- Tailwind CSS CDN ë¡œë“œ -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- CSS ìŠ¤íƒ€ì¼ ì‹œì‘ -->
    <style>
        /* ì»¤ìŠ¤í…€ ìŠ¤íƒ€ì¼: Inter í°íŠ¸ ëŒ€ì‹  í•œêµ­ì–´ í™˜ê²½ì— ì í•©í•œ ì‹œìŠ¤í…œ í°íŠ¸ ì‚¬ìš© */
        body { 
            font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif; 
            background-color: #1a1a2e; 
            color: #e0e0e0; 
        }
        /* ì§‘ì¤‘ë„ë¥¼ ë†’ì´ëŠ” ë‹¤í¬ í…Œë§ˆ */
        .container { 
            max-width: 1000px; 
        }
        .card { 
            background-color: #2c2c4b; 
            border: 1px solid #4a4a75; 
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4); 
        }
        .result-text { 
            font-size: 1.25rem; 
            font-weight: bold; 
            margin-top: 10px; 
        }
        .correct { 
            color: #50fa7b; 
        }
        .incorrect { 
            color: #ff5555; 
        }
        .timer-glow { 
            text-shadow: 0 0 10px #70a1ff; 
        }

        /* ëª¨ë°”ì¼ ìµœì í™”: ë¬¸ì œ ì˜ì—­ ë†’ì´ í™•ë³´ */
        @media (max-width: 768px) {
            #problem-display { 
                font-size: 2.5rem; 
            }
        }
    </style>
    <!-- CSS ìŠ¤íƒ€ì¼ ë -->
</head>
<body>

    <div id="app" class="container mx-auto p-4 md:p-8 min-h-screen flex flex-col items-center">
        
        <!-- í—¤ë” ë° íƒ€ì´í‹€ -->
        <header class="w-full text-center py-4 mb-8">
            <h1 class="text-4xl font-extrabold text-[#95d5b2] tracking-wider">ğŸ”¥ 1ëŒ€1 ì§‘ì¤‘ ìŠ¤í„°ë”” ì•± ğŸ”¥</h1>
            <p class="text-gray-400 mt-2">30ë¶„ ë™ì•ˆ ë¬´í•œ ë¬¸ì œ í’€ì´ë¡œ ìµœëŒ€ ì„±ì·¨ë„ì— ë„ì „í•˜ì„¸ìš”</p>
            <div id="nickname-area" class="mt-4 flex justify-center items-center">
                <input type="text" id="nickname-input" placeholder="ë‹‰ë„¤ì„ ì…ë ¥ (ìµëª… ë³´ì¥)" 
                       class="px-4 py-2 rounded-l-lg bg-[#3a3a5f] text-white border border-[#4a4a75] focus:outline-none focus:ring-2 focus:ring-[#95d5b2] w-40 md:w-64" maxlength="10">
                <button id="start-button" 
                        class="px-4 py-2 bg-[#70a1ff] text-white font-semibold rounded-r-lg hover:bg-[#5f8de5] transition duration-200 disabled:opacity-50">
                    ì‹œì‘
                </button>
            </div>
        </header>

        <!-- ë©”ì¸ ê²Œì„ UI -->
        <main id="game-ui" class="w-full hidden">
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                
                <!-- 1. íƒ€ì´ë¨¸ ë° í˜„ì¬ ìƒíƒœ -->
                <div class="md:col-span-1 card rounded-xl p-4 text-center">
                    <h2 class="text-lg font-bold text-gray-300">ë‚¨ì€ ì‹œê°„</h2>
                    <div id="timer-display" class="text-6xl font-mono mt-2 timer-glow text-[#95d5b2]">30:00</div>
                    <p id="game-status" class="text-sm mt-2 text-yellow-400">ëŒ€ê²° ì§„í–‰ ì¤‘</p>
                </div>

                <!-- 2. ì ìˆ˜íŒ (ì‹¤ì‹œê°„ ìˆœìœ„ ì‹œë®¬ë ˆì´ì…˜) -->
                <div class="md:col-span-2 card rounded-xl p-4">
                    <h2 class="text-lg font-bold text-gray-300 mb-2">ì‹¤ì‹œê°„ ì ìˆ˜ ë° ìˆœìœ„</h2>
                    <div id="scoreboard" class="space-y-2">
                        <!-- Player 1 (ë‚˜) -->
                        <div class="flex justify-between items-center p-2 bg-[#3a3a5f] rounded-lg border-l-4 border-[#95d5b2] scale-105 transform transition duration-300">
                            <span id="player-nickname" class="text-xl font-bold"></span>
                            <span class="text-2xl font-mono text-[#95d5b2]"><span id="my-score">0</span> ì </span>
                        </div>
                        <!-- Player 2 (ì‹œë®¬ë ˆì´ì…˜ ìƒëŒ€) -->
                        <div class="flex justify-between items-center p-2 bg-[#3a3a5f] rounded-lg opacity-70">
                            <span class="text-xl font-medium text-gray-400">ëœë¤ ê²½ìŸì âš”ï¸</span>
                            <span class="text-2xl font-mono text-gray-400"><span id="rival-score">0</span> ì </span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 3. ë¬¸ì œ í’€ì´ ì˜ì—­ -->
            <div class="card rounded-xl p-6 md:p-10 mb-6 flex flex-col items-center">
                <p class="text-md text-gray-400 mb-4">í˜„ì¬ ë‚œì´ë„: <span id="difficulty-level" class="font-bold text-yellow-400">ê¸°ì´ˆ</span></p>
                
                <!-- ë¬¸ì œ ë””ìŠ¤í”Œë ˆì´ -->
                <div id="problem-display" class="text-5xl md:text-6xl font-extrabold text-white mb-6 text-center">
                    ë¬¸ì œë¥¼ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘...
                </div>
                
                <!-- ë‹µì•ˆ ì…ë ¥ ë° ê²°ê³¼ í‘œì‹œ -->
                <div class="w-full max-w-sm flex flex-col items-center">
                    <div class="flex w-full">
                        <input type="number" id="answer-input" placeholder="ì—¬ê¸°ì— ë‹µ ì…ë ¥" 
                               class="w-full px-4 py-3 text-2xl rounded-l-lg bg-[#1a1a2e] text-white border-2 border-[#4a4a75] focus:outline-none focus:border-[#70a1ff]"
                               disabled>
                        <button id="submit-button" 
                                class="px-6 py-3 bg-[#ff5555] text-white font-bold text-lg rounded-r-lg hover:bg-[#d04444] transition duration-200 disabled:opacity-50"
                                disabled>
                            í™•ì¸
                        </button>
                    </div>
                    <!-- ì¦‰ê°ì ì¸ í”¼ë“œë°± ë©”ì‹œì§€ -->
                    <div id="feedback-message" class="result-text text-center h-8 mt-2"></div>
                </div>
            </div>
            
            <!-- 4. í†µê³„ ë° ì„±ì·¨ë„ -->
            <div class="card rounded-xl p-6">
                <h2 class="text-lg font-bold text-gray-300 mb-4">ë‚˜ì˜ ì„±ì·¨ë„ í†µê³„</h2>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                    <div class="p-3 bg-[#3a3a5f] rounded-lg">
                        <p class="text-sm text-gray-400">ì´ ë¬¸ì œ ìˆ˜</p>
                        <p id="stats-total" class="text-3xl font-bold text-white">0</p>
                    </div>
                    <div class="p-3 bg-[#3a3a5f] rounded-lg">
                        <p class="text-sm text-gray-400">ì •í™•ë„</p>
                        <p id="stats-accuracy" class="text-3xl font-bold text-white">0%</p>
                    </div>
                    <div class="p-3 bg-[#3a3a5f] rounded-lg">
                        <p class="text-sm text-gray-400">ìµœëŒ€ ì •ë‹µ ì—°ì†</p>
                        <p id="stats-streak" class="text-3xl font-bold text-white">0</p>
                    </div>
                    <div class="p-3 bg-[#3a3a5f] rounded-lg">
                        <p class="text-sm text-gray-400">ìµœê³  ì ìˆ˜ (Local)</p>
                        <p id="stats-best-score" class="text-3xl font-bold text-yellow-500">0</p>
                    </div>
                </div>
            </div>
        </main>

        <!-- ê²°ê³¼ ëª¨ë‹¬ (Modal) -->
        <div id="result-modal" class="fixed inset-0 bg-black bg-opacity-80 z-50 hidden items-center justify-center p-4">
            <div class="bg-white text-gray-900 rounded-xl p-8 max-w-lg w-full text-center card">
                <h2 id="modal-title" class="text-4xl font-extrabold text-[#1a1a2e] mb-4">ì‹œê°„ ì¢…ë£Œ! ìˆ˜ê³ í–ˆì–´ìš” ğŸ‘</h2>
                <p class="text-lg mb-6">ìµœì¢… ì„±ì  ë° í”¼ë“œë°±ì…ë‹ˆë‹¤.</p>
                
                <div class="space-y-3 mb-6 p-4 bg-gray-100 rounded-lg">
                    <p class="text-2xl font-bold">ìµœì¢… ì ìˆ˜: <span id="final-score" class="text-[#70a1ff]">0</span>ì </p>
                    <p class="text-xl">ì •í™•ë„: <span id="final-accuracy" class="text-green-600">0%</span></p>
                    <p class="text-xl">ìµœëŒ€ ë‚œì´ë„: <span id="final-difficulty" class="text-yellow-600">ê¸°ì´ˆ</span></p>
                </div>
                
                <p id="feedback-summary" class="text-md text-gray-700 mb-8"></p>

                <button id="restart-button" class="px-8 py-3 bg-[#ff5555] text-white font-bold rounded-lg hover:bg-[#d04444] transition duration-200">
                    ë‹¤ì‹œ ë„ì „!
                </button>
            </div>
        </div>
    </div>

    <!-- JavaScript ë¡œì§ ì‹œì‘ -->
    <script>
        // ì „ì—­ ë³€ìˆ˜ ì„¤ì •
        const GAME_DURATION = 30 * 60; // 30ë¶„ (ì´ˆ)
        const LOCAL_STORAGE_KEY = 'competitiveStudyApp';
        const RIval_SCORE_INCREMENT_INTERVAL = 5000; // 5ì´ˆë§ˆë‹¤ ë¼ì´ë²Œ ì ìˆ˜ ì—…ë°ì´íŠ¸

        let gameState = {
            nickname: 'í”Œë ˆì´ì–´',
            score: 0,
            rivalScore: 0,
            timeLeft: GAME_DURATION,
            totalProblems: 0,
            correctAnswers: 0,
            currentStreak: 0,
            maxStreak: 0,
            difficulty: 1, // 1: ê¸°ì´ˆ, 2: ì¼ë°˜, 3: ì‹¬í™”
            bestScore: 0,
            problemHistory: new Set(), // ë¬¸ì œ ì¤‘ë³µ ë°©ì§€ Set (ì˜ˆ: '12+5')
            isGameRunning: false,
            timerInterval: null,
            rivalInterval: null,
            lastSubmissionTime: 0,
            maxDifficultyReached: 1,
        };

        // --- UI ìš”ì†Œ ìºì‹œ ---
        const ui = {
            nicknameArea: document.getElementById('nickname-area'),
            startButton: document.getElementById('start-button'),
            gameUI: document.getElementById('game-ui'),
            nicknameInput: document.getElementById('nickname-input'),
            playerNickname: document.getElementById('player-nickname'),
            timerDisplay: document.getElementById('timer-display'),
            gameStatus: document.getElementById('game-status'),
            myScore: document.getElementById('my-score'),
            rivalScore: document.getElementById('rival-score'),
            difficultyLevel: document.getElementById('difficulty-level'),
            problemDisplay: document.getElementById('problem-display'),
            answerInput: document.getElementById('answer-input'),
            submitButton: document.getElementById('submit-button'),
            feedbackMessage: document.getElementById('feedback-message'),
            statsTotal: document.getElementById('stats-total'),
            statsAccuracy: document.getElementById('stats-accuracy'),
            statsStreak: document.getElementById('stats-streak'),
            statsBestScore: document.getElementById('stats-best-score'),
            resultModal: document.getElementById('result-modal'),
            modalTitle: document.getElementById('modal-title'),
            finalScore: document.getElementById('final-score'),
            finalAccuracy: document.getElementById('final-accuracy'),
            finalDifficulty: document.getElementById('final-difficulty'),
            feedbackSummary: document.getElementById('feedback-summary'),
            restartButton: document.getElementById('restart-button'),
        };

        // --- 1. ë°ì´í„° ë° ë¡œì»¬ ì €ì¥ì†Œ ê´€ë¦¬ ---

        /** ë¡œì»¬ ì €ì¥ì†Œì—ì„œ ìƒíƒœ ë¡œë“œ */
        function loadState() {
            const data = localStorage.getItem(LOCAL_STORAGE_KEY);
            if (data) {
                const savedState = JSON.parse(data);
                gameState.bestScore = savedState.bestScore || 0;
                ui.statsBestScore.textContent = gameState.bestScore.toLocaleString();
            }
        }

        /** ë¡œì»¬ ì €ì¥ì†Œì— í˜„ì¬ ìµœê³  ì ìˆ˜ ì €ì¥ */
        function saveBestScore() {
            localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify({
                bestScore: gameState.bestScore
            }));
        }

        // --- 2. ë¬¸ì œ ìë™ ê³µê¸‰ ë¡œì§ ---

        /** * ë‚œì´ë„ì— ë”°ë¥¸ ë¬¸ì œ ë²”ìœ„ë¥¼ ì •ì˜ 
         * [ìµœì†Œê°’, ìµœëŒ€ê°’, ì ìˆ˜ ë°°ìœ¨, ë‚œì´ë„ ë ˆì´ë¸”]
         */
        const difficultyConfig = {
            1: [1, 10, 100, 'ê¸°ì´ˆ (ë‹¨ìˆœ ë§ì…ˆ/ëº„ì…ˆ)'], // 100ì 
            2: [10, 50, 200, 'ì¼ë°˜ (ë‘ ìë¦¬ ìˆ˜ ì—°ì‚°)'], // 200ì 
            3: [50, 100, 300, 'ì‹¬í™” (ì„¸ ìë¦¬ ìˆ˜ ì—°ì‚° / ê³±ì…ˆ ì¶”ê°€)'], // 300ì 
            4: [100, 500, 500, 'ìµœê³  ë‚œì´ë„ (ëŒ€ìˆ˜ / ë³µí•© ì—°ì‚°)'], // 500ì 
        };

        /** * ë¬¸ì œ ì¤‘ë³µì„ í”¼í•˜ë©° ë‹¤ìŒ ë¬¸ì œë¥¼ ìƒì„± 
         * @returns {object} { text: 'A + B', answer: C, difficulty: D }
         */
        function generateProblem() {
            let maxAttempts = 10;
            let problem = null;

            while (maxAttempts > 0) {
                maxAttempts--;
                
                const config = difficultyConfig[gameState.difficulty];
                if (!config) break;

                const [min, max, score, label] = config;
                
                // ë‚œì´ë„ì— ë”°ë¼ ì—°ì‚° ì¢…ë¥˜ ê²°ì •
                let operators = ['+', '-'];
                if (gameState.difficulty >= 3) {
                    operators.push('*');
                }

                const op = operators[Math.floor(Math.random() * operators.length)];
                
                // ë²”ìœ„ ë‚´ì—ì„œ ë‘ ìˆ«ì ìƒì„±
                const num1 = Math.floor(Math.random() * (max - min + 1)) + min;
                const num2 = Math.floor(Math.random() * (max - min + 1)) + min;
                
                let answer;
                let text;

                switch (op) {
                    case '+':
                        answer = num1 + num2;
                        text = `${num1} + ${num2}`;
                        break;
                    case '-':
                        // ìŒìˆ˜ ë°©ì§€ (ëº„ì…ˆì˜ ê²½ìš°)
                        if (num1 < num2) {
                            answer = num2 - num1;
                            text = `${num2} - ${num1}`;
                        } else {
                            answer = num1 - num2;
                            text = `${num1} - ${num2}`;
                        }
                        break;
                    case '*':
                        answer = num1 * num2;
                        text = `${num1} * ${num2}`;
                        // ê³±ì…ˆì€ ë‚œì´ë„ë¥¼ ìœ„í•´ ìˆ«ìì˜ ë²”ìœ„ë¥¼ ì•½ê°„ ì œí•œ
                        if (num1 > 50 || num2 > 50) continue; 
                        break;
                }
                
                const problemKey = `${text}=${answer}`;

                // ë¬¸ì œ ì¤‘ë³µ ê²€ì‚¬
                if (!gameState.problemHistory.has(problemKey)) {
                    problem = { text, answer, score, problemKey, difficulty: gameState.difficulty };
                    gameState.problemHistory.add(problemKey);
                    break;
                }
            }
            
            // ì¤‘ë³µëœ ë¬¸ì œê°€ ë„ˆë¬´ ë§ìœ¼ë©´ ì´ì „ ê¸°ë¡ì„ ì§€ìš°ê³  ìƒˆ ë¬¸ì œ ìƒì„± ìœ ë„ (ìƒˆ ë¬¸ì œ ìš°ì„  ì œê³µ ë¡œì§)
            if (!problem) {
                gameState.problemHistory.clear();
                return generateProblem(); 
            }

            return problem;
        }

        let currentProblem = null;

        /** ë¬¸ì œ ì¶œì œ ë° UI ì—…ë°ì´íŠ¸ */
        function setNextProblem() {
            currentProblem = generateProblem();
            ui.problemDisplay.textContent = currentProblem.text;
            ui.answerInput.value = ''; // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
            ui.answerInput.focus(); // ìë™ í¬ì»¤ìŠ¤
            ui.feedbackMessage.textContent = ''; // í”¼ë“œë°± ë©”ì‹œì§€ ì´ˆê¸°í™”
            
            // ë‚œì´ë„ UI ì—…ë°ì´íŠ¸
            ui.difficultyLevel.textContent = difficultyConfig[gameState.difficulty][3];
            // ìµœê³  ë‚œì´ë„ ê¸°ë¡
            if (gameState.difficulty > gameState.maxDifficultyReached) {
                gameState.maxDifficultyReached = gameState.difficulty;
            }
        }

        /** ë‚œì´ë„ ìë™ ì¡°ì ˆ ë¡œì§ */
        function adjustDifficulty(isCorrect) {
            const MAX_DIFFICULTY = 4;
            const difficulty = gameState.difficulty;

            if (isCorrect) {
                gameState.currentStreak++;
                if (gameState.currentStreak > gameState.maxStreak) {
                    gameState.maxStreak = gameState.currentStreak;
                }

                // 3ì—°ì† ì •ë‹µ ì‹œ ë‚œì´ë„ ìƒìŠ¹ (ìµœëŒ€ ë‚œì´ë„ 4)
                if (gameState.currentStreak >= 3 && difficulty < MAX_DIFFICULTY) {
                    gameState.difficulty++;
                    gameState.currentStreak = 0; // ë‚œì´ë„ ì¡°ì ˆ í›„ ìŠ¤íŠ¸ë¦­ ì´ˆê¸°í™”
                    showFeedback('ë‚œì´ë„ ìƒìŠ¹! â¬†ï¸', 'text-yellow-400');
                }
            } else {
                gameState.currentStreak = 0; // ì˜¤ë‹µ ì‹œ ìŠ¤íŠ¸ë¦­ ì´ˆê¸°í™”
                
                // 2ì—°ì† ì˜¤ë‹µ ì‹œ ë‚œì´ë„ í•˜ë½ (ìµœì†Œ ë‚œì´ë„ 1)
                // (ì´ì „ ë¬¸ì œë„ í‹€ë ¸ë‹¤ê³  ê°€ì •í•˜ê³ , 2ë²ˆ í‹€ë¦¬ë©´ í•˜ë½ ë¡œì§ ì ìš©)
                if (difficulty > 1 && gameState.totalProblems > 0 && 
                    gameState.correctAnswers < gameState.totalProblems - 1) { 
                    
                    gameState.difficulty--;
                    showFeedback('ë‚œì´ë„ í•˜ë½ â¬‡ï¸ ë‹¤ì‹œ ì§‘ì¤‘!', 'text-red-400');
                }
            }
        }

        // --- 3. ê²Œì„ ì—”ì§„ ë° íƒ€ì´ë¨¸ ---

        /** íƒ€ì´ë¨¸ ì‹œì‘ */
        function startTimer() {
            gameState.isGameRunning = true;
            ui.gameStatus.textContent = 'ëŒ€ê²° ì§„í–‰ ì¤‘';
            
            gameState.timerInterval = setInterval(() => {
                gameState.timeLeft--;
                updateTimerDisplay();

                if (gameState.timeLeft <= 0) {
                    endGame();
                }
            }, 1000);

            // ë¼ì´ë²Œ ì ìˆ˜ ì‹œë®¬ë ˆì´ì…˜ ì‹œì‘ (ì‹¤ì œ ì„œë²„ê°€ ì—†ìœ¼ë¯€ë¡œ ì„ì‹œë¡œ êµ¬í˜„)
            gameState.rivalInterval = setInterval(updateRivalScore, RIval_SCORE_INCREMENT_INTERVAL);
        }

        /** íƒ€ì´ë¨¸ ë””ìŠ¤í”Œë ˆì´ ì—…ë°ì´íŠ¸ */
        function updateTimerDisplay() {
            const minutes = Math.floor(gameState.timeLeft / 60);
            const seconds = gameState.timeLeft % 60;
            ui.timerDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            // 1ë¶„ ë¯¸ë§Œ ê²½ê³  ìŠ¤íƒ€ì¼
            if (gameState.timeLeft < 60) {
                ui.timerDisplay.classList.add('text-red-500', 'animate-pulse');
            } else {
                ui.timerDisplay.classList.remove('text-red-500', 'animate-pulse');
            }
        }

        /** ë¼ì´ë²Œ ì ìˆ˜ ì‹œë®¬ë ˆì´ì…˜ ì—…ë°ì´íŠ¸ */
        function updateRivalScore() {
            // ë¼ì´ë²Œì€ í‰ê· ì ìœ¼ë¡œ í”Œë ˆì´ì–´ë³´ë‹¤ ì•½ê°„ ë†’ê±°ë‚˜ ë‚®ì€ ì ìˆ˜ë¥¼ íšë“í•˜ë„ë¡ ì‹œë®¬ë ˆì´ì…˜
            const baseGain = Math.floor(Math.random() * 150) + 50; // 50~200ì 
            const difficultyFactor = gameState.difficulty * 0.1;
            const luckFactor = Math.random() < 0.3 ? 2 : 1; // ê°€ë” 2ë°° ì ìˆ˜
            
            // í”Œë ˆì´ì–´ ì ìˆ˜ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ë‚œì´ë„ì— ë”°ë¥¸ ì ìˆ˜ ì¦ê°€ ì‹œë®¬ë ˆì´ì…˜
            gameState.rivalScore += Math.round(baseGain * luckFactor * (1 + difficultyFactor));
            ui.rivalScore.textContent = gameState.rivalScore.toLocaleString();
        }

        /** ê²Œì„ ì¢…ë£Œ ë° ê²°ê³¼ í‘œì‹œ */
        function endGame() {
            clearInterval(gameState.timerInterval);
            clearInterval(gameState.rivalInterval);
            gameState.isGameRunning = false;
            
            // ì…ë ¥ ë¹„í™œì„±í™”
            ui.answerInput.disabled = true;
            ui.submitButton.disabled = true;
            ui.gameStatus.textContent = 'ê²Œì„ ì¢…ë£Œ';
            
            // ìµœê³  ì ìˆ˜ ì—…ë°ì´íŠ¸ ë° ì €ì¥
            if (gameState.score > gameState.bestScore) {
                gameState.bestScore = gameState.score;
                saveBestScore();
            }

            // ëª¨ë‹¬ ì—…ë°ì´íŠ¸ ë° í‘œì‹œ
            showResultModal();
        }

        // --- 4. ì‚¬ìš©ì ì…ë ¥ ë° ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ---

        /** ì •ë‹µ í™•ì¸ ë¡œì§ */
        function checkAnswer() {
            if (!gameState.isGameRunning || !currentProblem) return;

            const inputTime = Date.now();
            
            // ğŸš¨ ì•…ìš© ë°©ì§€ ê¸°ë³¸ ê¸°ëŠ¥: ë„ˆë¬´ ë¹ ë¥¸ ì—°ì† ë‹µë³€ ì œí•œ (0.5ì´ˆ ì´ë‚´)
            if (inputTime - gameState.lastSubmissionTime < 500) {
                showFeedback('ğŸš¨ ë„ˆë¬´ ë¹ ë¦…ë‹ˆë‹¤! ì²œì²œíˆ í’€ì–´ìš”.', 'text-red-500');
                return;
            }
            gameState.lastSubmissionTime = inputTime;

            const userAnswer = parseInt(ui.answerInput.value, 10);

            if (isNaN(userAnswer)) {
                showFeedback('ìˆ«ìë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.', 'text-yellow-500');
                return;
            }

            gameState.totalProblems++;
            let isCorrect = (userAnswer === currentProblem.answer);

            if (isCorrect) {
                gameState.correctAnswers++;
                gameState.score += currentProblem.score;
                showFeedback(`ì •ë‹µ! (+${currentProblem.score}ì )`, 'correct');
            } else {
                gameState.score -= Math.floor(currentProblem.score / 5); // ì˜¤ë‹µ ì‹œ í˜ë„í‹°
                if (gameState.score < 0) gameState.score = 0;
                showFeedback(`ì˜¤ë‹µ âŒ ì •ë‹µ: ${currentProblem.answer}`, 'incorrect');
            }

            // ì ìˆ˜ ë° í†µê³„ ì—…ë°ì´íŠ¸
            updateStats(isCorrect);
            
            // ë‚œì´ë„ ì¡°ì ˆ
            adjustDifficulty(isCorrect);

            // ë‹¤ìŒ ë¬¸ì œ ì¶œì œ
            setTimeout(setNextProblem, 500); // 0.5ì´ˆ í›„ ë‹¤ìŒ ë¬¸ì œ
        }

        /** í†µê³„ UI ì—…ë°ì´íŠ¸ */
        function updateStats(isCorrect) {
            ui.myScore.textContent = gameState.score.toLocaleString();
            ui.statsTotal.textContent = gameState.totalProblems;
            ui.statsBestScore.textContent = gameState.bestScore.toLocaleString();
            
            const accuracy = gameState.totalProblems === 0 
                ? 0 
                : ((gameState.correctAnswers / gameState.totalProblems) * 100).toFixed(1);
            
            ui.statsAccuracy.textContent = `${accuracy}%`;
            ui.statsStreak.textContent = gameState.currentStreak;
        }

        /** ì¦‰ê°ì ì¸ í”¼ë“œë°± ë©”ì‹œì§€ ì¶œë ¥ */
        function showFeedback(message, className) {
            ui.feedbackMessage.className = `result-text text-center h-8 mt-2 ${className}`;
            ui.feedbackMessage.textContent = message;
        }

        /** ê²°ê³¼ ëª¨ë‹¬ í‘œì‹œ */
        function showResultModal() {
            const totalProblems = gameState.totalProblems;
            const correctRate = ((gameState.correctAnswers / totalProblems) * 100).toFixed(1);
            const difficultyLabel = difficultyConfig[gameState.maxDifficultyReached] ? difficultyConfig[gameState.maxDifficultyReached][3] : 'ê¸°ì´ˆ';
            
            ui.finalScore.textContent = gameState.score.toLocaleString();
            ui.finalAccuracy.textContent = `${correctRate}%`;
            ui.finalDifficulty.textContent = difficultyLabel.split(' ')[0];

            let summary = '';
            if (correctRate >= 90) {
                summary = `ì •í™•ë„ê°€ ${correctRate}%ë¡œ ë§¤ìš° ë†’ìŠµë‹ˆë‹¤! ë‹¤ìŒì—ëŠ” ${difficultyLabel.split(' ')[0]} ë‚œì´ë„ë¥¼ ì™„ë²½í•˜ê²Œ ë§ˆìŠ¤í„°í•˜ëŠ” ê²ƒì„ ëª©í‘œë¡œ í•´ë³´ì„¸ìš”.`;
            } else if (correctRate >= 70) {
                summary = `ê½¤ ì¢‹ì€ ì„±ì ì…ë‹ˆë‹¤. ì •í™•ë„ë¥¼ 90% ì´ìƒìœ¼ë¡œ ëŒì–´ì˜¬ë¦¬ë©´ì„œ ì†ë„ë¥¼ ë†’ì´ëŠ” ì—°ìŠµì´ í•„ìš”í•©ë‹ˆë‹¤.`;
            } else {
                summary = `ì •í™•ë„ê°€ ë‚®ì•„ìš” ğŸ˜¥. ì ì‹œ ì‰¬ê³ , ê¸°ë³¸ ê°œë…ì„ ë³µìŠµí•œ ë’¤ ë‹¤ì‹œ ë„ì „í•´ ë´…ì‹œë‹¤!`;
            }

            ui.feedbackSummary.textContent = summary;
            ui.resultModal.classList.remove('hidden');
            ui.resultModal.classList.add('flex');
        }

        // --- 5. ì´ˆê¸°í™” ë° ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì • ---

        /** ê²Œì„ ì´ˆê¸°í™” */
        function resetGame() {
            // ê²Œì„ ìƒíƒœ ì´ˆê¸°í™”
            gameState = {
                ...gameState, // ìµœê³  ì ìˆ˜ëŠ” ìœ ì§€
                score: 0,
                rivalScore: 0,
                timeLeft: GAME_DURATION,
                totalProblems: 0,
                correctAnswers: 0,
                currentStreak: 0,
                difficulty: 1,
                problemHistory: new Set(),
                isGameRunning: false,
                maxDifficultyReached: 1,
            };
            
            // UI ì´ˆê¸°í™”
            ui.gameUI.classList.add('hidden');
            ui.nicknameArea.classList.remove('hidden');
            ui.answerInput.disabled = true;
            ui.submitButton.disabled = true;
            ui.answerInput.value = '';
            ui.timerDisplay.classList.remove('text-red-500', 'animate-pulse');
            
            // ëª¨ë“  í†µê³„ ì—…ë°ì´íŠ¸ (0ìœ¼ë¡œ)
            updateStats(false);
            ui.rivalScore.textContent = '0';
            ui.problemDisplay.textContent = 'ë¬¸ì œë¥¼ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘...';
            ui.feedbackMessage.textContent = '';
            ui.gameStatus.textContent = 'ëŒ€ê²° ì‹œì‘ ì „';
            updateTimerDisplay(); // íƒ€ì´ë¨¸ 30:00ìœ¼ë¡œ ì´ˆê¸°í™”
            
            // ëª¨ë‹¬ ë‹«ê¸°
            ui.resultModal.classList.add('hidden');
            ui.resultModal.classList.remove('flex');
            
            ui.nicknameInput.focus();
        }

        /** 'ì‹œì‘' ë²„íŠ¼ í´ë¦­ í•¸ë“¤ëŸ¬ */
        ui.startButton.addEventListener('click', () => {
            let nickname = ui.nicknameInput.value.trim();
            if (nickname.length === 0) {
                nickname = 'ìµëª… ë„ì „ì';
            }
            
            // ë‹‰ë„¤ì„ ì„¤ì • ë° UI ì „í™˜
            gameState.nickname = nickname;
            ui.playerNickname.textContent = `${nickname} (ë‚˜)`;
            ui.nicknameArea.classList.add('hidden');
            ui.gameUI.classList.remove('hidden');
            
            // ê²Œì„ ì‹œì‘ ì¤€ë¹„
            ui.answerInput.disabled = false;
            ui.submitButton.disabled = false;
            
            setNextProblem(); // ì²« ë¬¸ì œ ì¶œì œ
            startTimer(); // íƒ€ì´ë¨¸ ì‹œì‘
        });

        /** 'í™•ì¸' ë²„íŠ¼ ë˜ëŠ” Enter í‚¤ ì…ë ¥ ì²˜ë¦¬ */
        ui.submitButton.addEventListener('click', checkAnswer);
        ui.answerInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault(); // ê¸°ë³¸ Enter ë™ì‘(í¼ ì œì¶œ ë“±) ë°©ì§€
                checkAnswer();
            }
        });

        /** 'ë‹¤ì‹œ ë„ì „' ë²„íŠ¼ í´ë¦­ í•¸ë“¤ëŸ¬ */
        ui.restartButton.addEventListener('click', () => {
            resetGame();
        });

        // --- ì•± ì´ˆê¸°í™” ì‹¤í–‰ ---
        window.onload = () => {
            loadState();
            updateTimerDisplay();
            resetGame();
            
            // ë‹‰ë„¤ì„ ì…ë ¥ í›„ Enter í‚¤ë¡œ ë°”ë¡œ ì‹œì‘ ê°€ëŠ¥
            ui.nicknameInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    ui.startButton.click();
                }
            });
        };
    </script>
    <!-- JavaScript ë¡œì§ ë -->
</body>
</html>